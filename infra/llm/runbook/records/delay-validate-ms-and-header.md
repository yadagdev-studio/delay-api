# Task: delay-validate-ms-and-header

## 背景 / 問題
- `/delay?ms=` が異常入力（未指定・非数値・負数・過大）でも動作し得ると、想定外の負荷や挙動ブレにつながる。
- 運用観測として「実際に受理した遅延値」をログではなくレスポンスで軽く確認できると便利。

## 目的
- `/delay` の入力を厳密化して安全にする（異常入力は 400）。
- 正常時に観測用ヘッダ `X-Delay-MS` を返し、リクエストの受理値を追えるようにする。
- 変更は小粒で、ロールバック容易にする。

## 仕様
### 対象
- `GET /delay?ms=<number>`

### バリデーション
- `ms` 未指定 → 400
- `ms` が数値でない → 400
- `ms` が負数 → 400
- `ms` が上限超過 → 400
- 上限: `30000` ms
- `ms=0` は許可（即時返却）

### 正常時
- レスポンスヘッダ `X-Delay-MS: <number>` を付与する
- 既存のレスポンス形式（JSON/テキスト等）は壊さない（必要なら現状踏襲）

### 非対象（今回はやらない）
- 認証方式、TLS、proxy設定の変更
- `/healthz` の仕様変更
- リクエストレート制限の追加（proxy側の話なので今回の範囲外）

## 受け入れ基準（必須）
- `GET /delay?ms=123` が成功し、`X-Delay-MS: 123` が付与される
- 以下が 400:
  - `/delay`（msなし）
  - `/delay?ms=`
  - `/delay?ms=abc`
  - `/delay?ms=-1`
  - `/delay?ms=30001`
- `/healthz` は挙動変更なし
- 自動テストを最低1つ以上追加し、CIで緑になる

## 実装方針（指針）
- 上限は定数化する（例: `MAX_DELAY_MS = 30000`）
- `ms` は整数として扱う（小数は 400 でOK）
- 400時のボディは最小（例: errorメッセージ）でよいが、秘密情報は載せない

## 検証手順（例）
- ローカル or コンテナで以下を実行し、ステータスとヘッダを確認:
  - `/delay?ms=123` → 2xx + `X-Delay-MS`
  - 異常系 → 400
- CIが通ること

## 影響範囲
- delay-api の `/delay` のみ（想定）

## ロールバック
- PR を revert → 再デプロイ
